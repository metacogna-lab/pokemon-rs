# ── Dev build: pokemon-cli ────────────────────────────────────────────────────
# Source directory is bind-mounted from the host; cargo compiles on container start.
# cargo-watch provides live reload when source files change.
FROM rust:1.82-slim-bookworm
RUN apt-get update \
 && apt-get install -y --no-install-recommends pkg-config libssl-dev curl \
 && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for live reload.
RUN cargo install cargo-watch

WORKDIR /app

# Pre-fetch dependencies into the cargo registry cache (invalidated only when
# Cargo.lock changes, not on source edits).
COPY Cargo.toml Cargo.lock ./
COPY cli/Cargo.toml       cli/
COPY controller/Cargo.toml controller/
RUN mkdir -p cli/src controller/src \
 && echo 'fn main(){}' > cli/src/main.rs \
 && touch controller/src/lib.rs \
 && cargo build -p pokemon-cli 2>/dev/null; true
RUN rm -rf cli/src controller/src

# In docker-compose.dev the full repo root is mounted at /app,
# so source changes are immediately visible.
EXPOSE 8080
CMD ["cargo", "watch", "-w", "cli/src", "-w", "controller/src", \
     "-x", "run -p pokemon-cli -- serve"]
